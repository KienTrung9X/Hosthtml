<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Form Ghi nh·∫≠n B·∫£o d∆∞·ª°ng</title>
  <!-- Office.js references -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js" type="text/javascript"></script>
  <style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .container {
    background: #ffffff;
    border-radius: 16px; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    padding: 32px;
    width: 100%;
    max-width: 800px;
    animation: fadeIn 0.5s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .form-header {
    text-align: center;
    margin-bottom: 32px;
  }

  .form-header h1 {
    color: #2d3748;
    font-size: 2.25rem;
    font-weight: 700;
    margin-bottom: 8px;
  }

  .form-header p {
    color: #718096;
    font-size: 1.1rem;
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 24px;
    margin-bottom: 28px;
  }

  label {
    display: block;
    margin-bottom: 8px;
    color: #4a5568;
    font-weight: 500;
    font-size: 0.95rem;
  }

  input, select, textarea {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 1rem;
    color: #2d3748;
    transition: all 0.2s;
    background: #fff;
  }

  input:focus, select:focus, textarea:focus {
    border-color: #4299e1;
    box-shadow: 0 0 0 3px rgba(66,153,225,0.15);
    outline: none;
  }

  .list-section {
    background: #f8fafc;
    border-radius: 12px;
    padding: 24px;
    margin: 24px 0;
  }

  .list-section h3 {
    color: #2d3748;
    font-size: 1.25rem;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .input-group {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
  }

  .list-item {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary {
    background: #4299e1;
    color: #fff;
  }

  .btn-primary:hover {
    background: #3182ce;
  }

  .btn-secondary {
    background: #718096;
    color: #fff;
  }

  .btn-danger {
    background: #f56565;
    color: #fff;
  }

  .btn-success {
    background: #48bb78;
    color: #fff;
  }

  .status-message {
    padding: 12px 16px;
    border-radius: 8px;
    margin: 16px 0;
    font-weight: 500;
    text-align: center;
  }

  .status-success {
    background: #c6f6d5;
    color: #276749;
  }

  .status-error {
    background: #fed7d7;
    color: #9b2c2c;
  }

  datalist {
  width: 100%;
  max-width: none;
}

input[list] {
  padding-right: 36px;
  background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E") no-repeat right 8px center;
  background-size: 16px;
}

/* KH√îI PH·ª§C date picker v√† cho ph√©p click */
input[type="date"] {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: textfield; /* avoid Firefox showing extra UI */
  padding: 12px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 1rem;
  color: #2d3748;
  background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24'%3E%3Cpath d='M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 18H4V8h16v13z' fill='%23718096'/%3E%3C/svg%3E") no-repeat right 8px center;
  background-size: 20px;
  cursor: pointer;
  position: relative;
}

/* Restore and expose native calendar control for WebKit */
input[type="date"]::-webkit-calendar-picker-indicator {
  display: block;
  opacity: 1;
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  width: 20px;
  height: 20px;
  cursor: pointer;
  pointer-events: auto;
  color: inherit;
  -webkit-appearance: menulist-button;
}

/* Firefox-specific: ensure clickability */
input[type="date"]::-moz-focus-inner {
  border: 0;
}

input[type="date"]:focus {
  border-color: #4299e1;
  box-shadow: 0 0 0 3px rgba(66,153,225,0.15);
  outline: none;
}

/* C·∫≠p nh·∫≠t style cho date picker tr√™n Firefox */
input[type="date"]::-moz-calendar-picker-indicator {
  opacity: 0;
  width: 100%;
  height: 100%;
  position: absolute;
  top: 0;
  left: 0;
  cursor: pointer;
}

  @media (max-width: 640px) {
    .container {
      padding: 24px;
    }
    
    .form-row {
      grid-template-columns: 1fr;
    }
  }
  </style>
</head>
<body>
<div class="container">
  <div class="form-header">
    <h1>üõ†Ô∏è Form Ghi nh·∫≠n B·∫£o d∆∞·ª°ng</h1>
    <p>Qu·∫£n l√Ω d·ªØ li·ªáu m√°y m√≥c v√† v·∫≠t t∆∞</p>
  </div>

  <form id="excelForm">
    <button type="button" onclick="writeToExcel()" class="btn btn-primary" style="margin-bottom: 10px;">L∆∞u v√†o Excel</button>
    <div class="form-row">
      <div>
        <label for="machine">M√°y:</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <input type="text" id="machine" name="machine" list="machineList" placeholder="-- Ch·ªçn m√°y --" class="combobox" style="flex:1; padding:12px 16px;">
          <datalist id="machineList">
            <option value="F2000905-ML_C0018">F2000905-ML_C0018 - 0048 - JNA</option>
            <option value="F2001002-MR_C054">F2001002-MR_C054 - 0030 - J9R</option>
            <option value="F2001002-ML_C054">F2001002-ML_C054 - 0009 - J9L</option>
            <option value="F2001002-MR_C039">F2001002-MR_C039 - 0029 - J8R</option>
            <option value="F2001002-ML_C039">F2001002-ML_C039 - 0008 - J8L</option>
            <option value="F2001002-MR_C038">F2001002-MR_C038 - 0028 - J7R</option>
            <option value="F2001002-ML_C038">F2001002-ML_C038 - 0007 - J7L</option>
            <option value="F2001002-MR_C037">F2001002-MR_C037 - 0027 - J6R</option>
            <option value="F2001002-ML_C037">F2001002-ML_C037 - 0006 - J6L</option>
            <option value="F2001002-MR_C036">F2001002-MR_C036 - 0026 - J5R</option>
            <option value="F2001002-ML_C036">F2001002-ML_C036 - 0005 - J5L</option>
            <option value="F2001002-MR_C035">F2001002-MR_C035 - 0025 - J4R</option>
            <option value="F2001002-ML_C035">F2001002-ML_C035 - 0004 - J4L</option>
            <option value="F2001002-MR_C034">F2001002-MR_C034 - 0024 - J3R</option>
            <option value="F2001002-ML_C034">F2001002-ML_C034 - 0003 - J3L</option>
            <option value="F2001002-MR_C033">F2001002-MR_C033 - 0023 - J2R</option>
            <option value="F2001002-ML_C033">F2001002-ML_C033 - 0002 - J2L</option>
            <option value="F2001002-MR_C032">F2001002-MR_C032 - 0022 - J1R</option>
            <option value="F2001002-ML_C032">F2001002-ML_C032 - 0001 - J1L</option>
            <option value="F2001002-MR_C056">F2001002-MR_C056 - 0034 - J13R</option>
            <option value="F2001002-ML_C056">F2001002-ML_C056 - 0013 - J13L</option>
            <option value="F2001002-MR_C055">F2001002-MR_C055 - 0033 - J12R</option>
            <option value="F2001002-ML_C055">F2001002-ML_C055 - 0012 - J12L</option>
            <option value="F2001002-MR_C057">F2001002-MR_C057 - 0032 - J11R</option>
            <option value="F2001002-ML_C057">F2001002-ML_C057 - 0011 - J11L</option>
            <option value="F2001002-MR_C053">F2001002-MR_C053 - 0031 - J10R</option>
            <option value="F2001002-ML_C053">F2001002-ML_C053 - 0010 - J10L</option>
            <option value="F2001104-ML_C010">F2001104-ML_C010 - 0045 - I9R</option>
            <option value="F2001104-ML_C011">F2001104-ML_C011 - 0043 - I9L</option>
            <option value="F2000907-MR_C164">F2000907-MR_C164 - 0042 - I8R</option>
            <option value="F2000907-ML_C164">F2000907-ML_C164 - 0021 - I8L</option>
            <option value="F2000907-MR_C152">F2000907-MR_C152 - 0041 - I7R</option>
            <option value="F2000907-ML_C152">F2000907-ML_C152 - 0020 - I7L</option>
            <option value="F2000907-MR_C123">F2000907-MR_C123 - 0040 - I6R</option>
            <option value="F2000907-ML_C123">F2000907-ML_C123 - 0019 - I6L</option>
            <option value="F2000907-MR_C122">F2000907-MR_C122 - 0039 - I5R</option>
            <option value="F2000907-ML_C122">F2000907-ML_C122 - 0018 - I5L</option>
            <option value="F2000907-MR_C121">F2000907-MR_C121 - 0038 - I4R</option>
            <option value="F2000907-ML_C121">F2000907-ML_C121 - 0017 - I4L</option>
            <option value="F2000907-MR_C120">F2000907-MR_C120 - 0037 - I3R</option>
            <option value="F2000907-ML_C120">F2000907-ML_C120 - 0016 - I3L</option>
            <option value="F2000907-MR_C119">F2000907-MR_C119 - 0036 - I2R</option>
            <option value="F2000907-ML_C119">F2000907-ML_C119 - 0015 - I2L</option>
            <option value="F2000907-MR_C118">F2000907-MR_C118 - 0035 - I1R</option>
            <option value="F2000907-ML_C118">F2000907-ML_C118 - 0014 - I1L</option>
            <option value="F2001104-MR_C010">F2001104-MR_C010 - 0046 - I10R</option>
            <option value="F2001104-MR_C011">F2001104-MR_C011 - 0044 - I10L</option>
            <option value="F2000905-MR_C0018">F2000905-MR_C0018 - 0047 - 0</option>
          </datalist>
          <!-- n√∫t th√™m nhanh (kh√¥ng b·∫Øt bu·ªôc) -->
          <button type="button" class="btn btn-primary btn-small" onclick="openMachineModal()" 
                  style="padding:6px 8px; font-size:0.85rem;">‚ûï</button>
        </div>
      </div>
      <div>
     <label for="machineType">Lo·∫°i b·∫£o d∆∞·ª°ng:</label>
<select id="machineType" name="machineType" class="combobox" required>
  <option value="">-- Ch·ªçn lo·∫°i --</option>
  <!-- ƒê·ªïi value ƒë·∫ßu th√†nh 'ad-hoc' ƒë·ªÉ ph√¢n bi·ªát v·ªõi 12 th√°ng -->
  <option value="ad-hoc">B·∫£o d∆∞·ª°ng ƒë·ªôt xu·∫•t</option>
  <option value="12">B·∫£o d∆∞·ª°ng 12 th√°ng</option>
  <option value="24">B·∫£o d∆∞·ª°ng 24 th√°ng</option>
  <option value="36">B·∫£o d∆∞·ª°ng 36 th√°ng</option>
  <option value="48">B·∫£o d∆∞·ª°ng 48 th√°ng</option>
  <option value="60">B·∫£o d∆∞·ª°ng 60 th√°ng</option>
  <option value="72">B·∫£o d∆∞·ª°ng 72 th√°ng</option>
  <option value="84">B·∫£o d∆∞·ª°ng 84 th√°ng</option>
  <option value="96">B·∫£o d∆∞·ª°ng 96 th√°ng</option>
  <option value="120">B·∫£o d∆∞·ª°ng 120 th√°ng</option>
</select>
      </div>
    </div>

    <div class="form-row">
      <div>
        <label for="maintenanceDate">Ng√†y b·∫£o d∆∞·ª°ng:</label>
        <input type="date" 
               id="maintenanceDate" 
               name="maintenanceDate" 
               required
               value="<?php echo date('Y-m-d'); ?>">
      </div>
      <div>
        <label for="shift">Ca l√†m vi·ªác:</label>
        <select id="shift" name="shift" class="combobox" required>
          <option value="">-- Ch·ªçn ca --</option>
          <option value="1">Ca 1 (06:00 - 14:00)</option>
          <option value="2">Ca 2 (14:00 - 22:00)</option>
          <option value="3">Ca 3 (22:00 - 06:00)</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div>
        <label for="technician">K·ªπ thu·∫≠t vi√™n:</label>
        <div style="display: flex; gap: 10px; align-items: center;">
          <select id="technician" name="technician" class="combobox" required style="flex: 1;">
            <option value="">-- Ch·ªçn k·ªπ thu·∫≠t vi√™n --</option>
            <option value="19070388">ƒêinh T·∫•n Tho - ID:19070388</option>
            <option value="20070359">D∆∞∆°ng Qu·ªëc Hi·ªáp - ID:20070359</option>
          </select>
          <button type="button" class="btn btn-primary btn-small" onclick="openTechnicianModal()" 
                  style="padding: 6px 8px; font-size: 0.75rem;">‚ûï KTV</button>
        </div>
      </div>
    </div>

    <div class="list-section">
      <h3>Danh s√°ch v·∫≠t t∆∞</h3>
      <div class="input-group">
        <input type="text" id="itemCode" placeholder="M√£ v·∫≠t t∆∞" list="itemCodeList">
        <datalist id="itemCodeList">
          <!-- DANH S√ÅCH ITEM CODE T·ª™ FILE -->
    <option value="A922646">A922646 - 6201ZZECM*AVEP2 - BEARING</option>
    <option value="A168299">A168299 - 6203ZZE - BALL BEARING</option>
    <option value="A898710">A898710 - F20005-MHF004-01 - COUPLING</option>
    <option value="A030218">A030218 - A208101 - ROLLER</option>
    <option value="A754551">A754551 - 6303ZZE - BALL BEARING</option>
    <option value="A042511">A042511 - 7011CYDF - ANGULAR BEARING</option>
    <option value="A029031">A029031 - 608ZZ - BALL BEARING</option>
    <option value="A824760">A824760 - F20010-M1V030-3CF - PRESS A HOLDER</option>
    <option value="A786565">A786565 - F20009-M1V031-5CI - HAMMER</option>
    <option value="A633287">A633287 - SHIM-%16X%10.3XT0.03 - SHIM</option>
    <option value="A836698">A836698 - F2001001-M1V031-3CF - SETTING HAMMER</option>
    <option value="A824764">A824764 - F20010-M1V057-3CF - CAGE</option>
    <option value="A841474">A841474 - F2001001-M1V010-01-3CF - SUPPORTING BAR</option>
    <option value="A658595">A658595 - F20007-M1B069 - CAGE</option>
    <option value="A903237">A903237 - F20009-M1V050-3CF - CAGE</option>
    <option value="A042340">A042340 - N701030 - GUIDE BEAD</option>
    <option value="A155855">A155855 - 6301ZZE - BALL BEARING</option>
    <option value="A934323">A934323 - F2001001-M5V001-3CFCAP - MANDREL HOLDER</option>
    <option value="A934324">A934324 - F2001001-M5V002-3CFCAP - MANDREL HOLDER</option>
    <option value="A810418">A810418 - F20009-M1V011-5CI - BACK-UP RING</option>
    <option value="A820654">A820654 - 1A-P12 - O-RING</option>
    <option value="A824761">A824761 - F20010-M1V011-01-3CF - BACK-UP RING</option>
    <option value="A867411">A867411 - F20009-M9V001-5CICAP - MANDREL HOLDER</option>
    <option value="A867412">A867412 - F20009-M9V002-5CICAP - MANDREL HOLDER</option>
    <option value="A823454">A823454 - 6200ZZE-IMI - BALL BEARING</option>
    <option value="A867407">A867407 - F20009-M1V010-03-5CI - SUPPORTING BAR</option>
    <option value="A032579">A032579 - 4-13GZZ - BALL BEARING</option>
    <option value="A633286">A633286 - SHIM-%11X%8XT0.03 - SHIM</option>
    <option value="A786589">A786589 - SHIM-%11X%8XT0.1 - SHIM</option>
    <option value="A841473">A841473 - F2001001-M1V009-01-3CF - MANDREL</option>
    <option value="A823456">A823456 - US-MR8X0.320E - ROUND BELT</option>
    <option value="A844165">A844165 - F2001001-MCD013-01 - TIMING PULLEY</option>
    <option value="A841472">A841472 - F2001001-M1V008-01-3CF - MANDREL</option>
    <option value="A046333">A046333 - A809005 - FLAT SPRING TENSER</option>
    <option value="A126859">A126859 - JO-37 - SNAP RING</option>
    <option value="A138237">A138237 - 6202ZZE - BALL BEARING</option>
    <option value="A138231">A138231 - 6001ZZE - BALL BEARING</option>
    <option value="A280175">A280175 - 7M-690 - POLYMAX BELT</option>
    <option value="A764173">A764173 - 608ZZMC3E(ENSSZ) - BEARING</option>
    <option value="A763148">A763148 - F20009-MMD018-01 - FELT</option>
    <option value="A028112">A028112 - 3/8"-TRIANGULAR - OIL STONE</option>
    <option value="A177262">A177262 - 13MM-ROUND - OIL STONE</option>
    <option value="A052661">A052661 - JO-47 - SNAP RING</option>
    <option value="A754589">A754589 - 1390-5GT-15 - TIMING BELT</option>
    <option value="A803810">A803810 - 1440-D5GT-20*MXX4N4 - TIMING BELT</option>
    <option value="A138235">A138235 - 6201ZZE - BALL BEARING</option>
    <option value="A894422">A894422 - JB-110-694-T2 - ROLLER</option>
    <option value="A830116">A830116 - F2000801-M1E017-01 - PRESS A HOLDER</option>
    <option value="A732960">A732960 - F2000702-M1C011 - BACK-UP RING</option>
    <option value="A926898">A926898 - F2000907-MMF012 - GUIDE ROLLER</option>
    <option value="A754255">A754255 - 6202ZZ+FNS2D - BALL BEARING</option>
    <option value="A035575">A035575 - 6002ZZE - BALL BEARING</option>
    <option value="A035574">A035574 - 6000ZZE - BALL BEARING</option>
    <option value="A867408">A867408 - F20009-M1V005-01-5CI - MANDREL HOLDER</option>
    <option value="A754550">A754550 - 1675-D5GT-15*MXX4N4 - TIMING BELT</option>
    <option value="A763142">A763142 - 1264-8YU-20 - TIMING BELT</option>
    <option value="A742260">A742260 - F2000702-M1C031-01 - SETTING HAMMER</option>
    <option value="A867404">A867404 - F20009-M1V008-03-5CI - MANDREL</option>
    <option value="A867406">A867406 - F20009-M1V009-03-5CI - MANDREL</option>
    <option value="A880509">A880509 - F20009-M1V005-45CFVNM - MANDREL HOLDER</option>
    <option value="A816817">A816817 - 1137-3GT-20 - TIMING BELT</option>
    <option value="A177264">A177264 - 13MM-TRIANGULAR - OIL STONE</option>
    <option value="A880378">A880378 - H33033-M01001 - THICKNESS GAUGE</option>
    <option value="A013126">A013126 - GLS-M1 - MAGNET</option>
    <option value="A013127">A013127 - GLS-S1 - PROXIMITY SENSOR</option>
    <option value="A848679">A848679 - CH-HL%10X108X220V-300W-L3M - CARTRIDGE HEATER</option>
    <option value="A803477">A803477 - CHR-3*%10X88-220V-150W-L2M - CARTRIDGE HEATER</option>
    <option value="A735463">A735463 - AWS5-30 - TENSION SPRING</option>
    <option value="A879654">A879654 - BL-02 - L TYPE FOLLOW WRENCH</option>
    <option value="A929221">A929221 - E45L12-PT3/8 - 45' ELBOW</option>
    <option value="A819633">A819633 - 872-8YU-20 - TIMING BELT</option>
    <option value="A840522">A840522 - 7M-580 - POLYMAX BELT</option>
    <option value="A805058">A805058 - SB10228 - OIL SEAL</option>
    <option value="A027181">A027181 - 1/4"-ROUND - OIL STONE</option>
    <option value="A028110">A028110 - 3/8"-ROUND - OIL STONE</option>
    <option value="A150734">A150734 - 0.05X12.7MMX5M - THICKNESS GAUGE</option>
    <option value="A310645">A310645 - 0.03X12.7MMX5M - THICKNESS GAUGE</option>
    <option value="A327278">A327278 - 0.01X12.7X5M - THICKNESS GAUGE</option>
    <option value="A633186">A633186 - F20007-M1A026 - THRUST COLLAR</option>
    <option value="A782328">A782328 - F20009-M1V022-5CFN - FORK</option>
    <option value="A782329">A782329 - F20009-M1V023-5CFN - FORK</option>
    <option value="A104379">A104379 - 1-SD - SOLDERLESS TERMINAL</option>
    <option value="A747451">A747451 - 100A25 - THICKNESS GAUGE</option>
    <option value="A794000">A794000 - F20009-M1V069-5CI - COLLAR</option>
    <option value="A836074">A836074 - F20010-M1V033-3CF - SHAFT</option>
    <option value="A840518">A840518 - F2001001-M1V024-3CF - FORK</option>
    <option value="A800727">A800727 - F20008-M2A001 - IDLER</option>
    <option value="A848682">A848682 - CH-HL%10X108X220V-100W-L3M - CARTRIDGE HEATER</option>
    <option value="A800689">A800689 - BL-03 - L TYPE FOLLOW WRENCH</option>
    <option value="A362434">A362434 - UFL002*FYH - PILLOW BLOCK</option>
    <option value="A805059">A805059 - SB17287 - OIL SEAL</option>
    <option value="A754534">A754534 - F20008-MCD004-01 - TIMING PULLEY</option>
    <option value="A850333">A850333 - F20009-M1V021-03-5CI - ELEMENT GUIDE BAR</option>
    <option value="A807606">A807606 - F2001001-M1V005-3CF - MANDREL HOLDER</option>
    <option value="A807607">A807607 - F2001001-M1V006-3CF - MANDREL HOLDER</option>
    <option value="A871989">A871989 - F20009-MZ1293 - ROLL</option>
    <option value="A776208">A776208 - 7M-850 - POLYMAX BELT</option>
    <option value="A776209">A776209 - 7M-560 - POLYMAX BELT</option>
    <option value="A931596">A931596 - 1248-EV8YU-20 - TIMING BELT</option>
    <option value="A880510">A880510 - F20009-M1V006-45CFVNM - MANDREL HOLDER</option>
    <option value="A880511">A880511 - F20009-M1V007-45CFVNM - MANDREL HOLDER</option>
    <option value="A732947">A732947 - F2000702-M1M018 - R-M SCREW</option>
    <option value="A799912">A799912 - F20009-M1V018-02-5CI - ELEMENT GUIDE BAR</option>
    <option value="A820859">A820859 - F2001001-M1V018-3CF - ELEMENT GUIDE BAR</option>
    <option value="A856536">A856536 - F2000702-M1M021-01 - ELEMENT GUIDE BAR</option>
    <option value="A732949">A732949 - F2000702-M1M020 - L-M SCREW</option>
    <option value="A799914">A799914 - F20009-M1V020-02-5CI - ELEMENT GUIDE BAR</option>
    <option value="A856535">A856535 - F2000702-M1M019-01 - ELEMENT GUIDE BAR</option>
    <option value="A820861">A820861 - F2001001-M1V020-3CF - ELEMENT GUIDE BAR</option>
    <option value="A850328">A850328 - F20009-M1V019-03-5CI - ELEMENT GUIDE BAR</option>
    <option value="A820653">A820653 - 1A-G115 - O-RING</option>
    <option value="A027182">A027182 - 1/4"-SQUARE - OIL STONE</option>
    <option value="A779710">A779710 - SD9225PT-24H - COOLING FAN</option>
    <option value="A889363">A889363 - F20010-M1V043-3CF - MIDDLE GEAR</option>
    <option value="A847852">A847852 - F2001001-M1V019-01-3CF - ELEMENT GUIDE BAR</option>
    <option value="A807608">A807608 - F2001001-M1V007-3CF - MANDREL HOLDER</option>
    <option value="A867409">A867409 - F20009-M1V006-01-5CI - MANDREL HOLDER</option>
    <option value="A867410">A867410 - F20009-M1V007-01-5CI - MANDREL HOLDER</option>
    <option value="A847851">A847851 - F2001001-M1V021-01-3CF - ELEMENT GUIDE BAR</option>
    <option value="A821651">A821651 - SFJT10-185-M5-WFC7-A74-E73 - SHAFT</option>
    <option value="A823586">A823586 - 1A-P11 - O-RING</option>
    <option value="A831230">A831230 - SMB1-20 - GEAR</option>
    <option value="A840520">A840520 - F2001001-M1V026-3CF - THRUST COLLAR</option>
    <option value="A820652">A820652 - 1A-G110 - O-RING</option>
    <option value="A825474">A825474 - 1A-G70 - O-RING</option>
    <option value="A867086">A867086 - 7011CYDB(M211) - BALL BEARING</option>
    <option value="A899777">A899777 - 1A-AS568-262 - O-RING</option>
    <option value="A177263">A177263 - 13MM-SQUARE - OIL STONE</option>
    <option value="A889362">A889362 - TAF172516 - NEEDLE BEARING</option>
    <option value="A713446">A713446 - NS-170 - SCISSORS</option>
    <option value="A736356">A736356 - E3Z-R61 - PHOTO MICRO SENSOR</option>
    <option value="A844084">A844084 - 1A-S6 - O-RING</option>
    <option value="A823455">A823455 - 6302ZZE-IMI - BALL BEARING</option>
    <option value="A830014">A830014 - F2000801-M1F017-01 - PRESS A HOLDER</option>
    <option value="A257824">A257824 - THW-03 - T-TYPE WRENCH</option>
    <option value="A257826">A257826 - THW-05 - T-TYPE WRENCH</option>
    <option value="A257827">A257827 - THW-06 - T-TYPE WRENCH</option>
    <option value="A257828">A257828 - THW-08 - T-TYPE WRENCH</option>
    <option value="A803933">A803933 - THW-2.5 - T-TYPE WRENCH</option>
    <option value="A840322">A840322 - NO.1983-10X - LOUPE</option>
    <option value="A018313">A018313 - RNA4900UU - NEEDLE BEARING</option>
    <option value="A168295">A168295 - 6003ZZE - BALL BEARING</option>
    <option value="A257825">A257825 - THW-04 - T-TYPE WRENCH</option>
    <option value="A786569">A786569 - F2000801-M1A038 - SHAFT</option>
    <option value="A803004">A803004 - FTM1-J25-81001-T004 - JIG</option>
    <option value="A803007">A803007 - FTM1-J25-81001-T007 - JIG</option>
    <option value="A018323">A018323 - RNA5902 - NEEDLE BEARING</option>
    <option value="A031901">A031901 - RNA4901 - NEEDLE BEARING</option>
    <option value="A676872">A676872 - SB20307 - OIL SEAL</option>
    <option value="A742100">A742100 - 6206ZZE - BALL BEARING</option>
    <option value="A747436">A747436 - SCALE-150MM*SUS - SCALE</option>
    <option value="A769239">A769239 - SMB1.5-20 - GEAR</option>
    <option value="A020067">A020067 - SBA-M5012 - HEXAGON SOCKET HEAD BOLT</option>
    <option value="A020094">A020094 - SBA-M6030 - HEXAGON SOCKET HEAD BOLT</option>
    <option value="A020095">A020095 - SBA-M6035 - HEXAGON SOCKET HEAD BOLT</option>
    <option value="A020895">A020895 - SW6 - SPRING WASHER</option>
    <option value="A025622">A025622 - W6 - WASHER</option>
    <option value="A031827">A031827 - N6*P=0.75 - NUT</option>
    <option value="A222585">A222585 - FU-35FA - FIBER UNIT</option>
    <option value="A746266">A746266 - F2000702-M1E083 - SHEET</option>
    <option value="A824762">A824762 - F20010-M1V056-3CF - SHEET</option>
    <option value="A835445">A835445 - SBH-M6025*P=0.75 - HEXAGON HEADED BOLT</option>
    <option value="A868113">A868113 - F24003-M1R210-3CE - STOPPER</option>
    <option value="A897193">A897193 - F24003-M1V206-3CE - NEEDLE HOLDER</option>
    <option value="A911544">A911544 - CIMRSF-D90-V80-T0.05 - SHIM RING</option>
    <option value="A924476">A924476 - F20009-MKJ057 - JIG</option>
    <option value="A026509">A026509 - YNL-MD-56033 - SLEEVE</option>
    <option value="A778181">A778181 - TA1220Z - NEEDLE BEARING</option>
    <option value="A838744">A838744 - MB-CX - MAGNETIC BASE</option>
    <option value="A840519">A840519 - F2001001-M1V025-3CF - FORK</option>
    <option value="A872689">A872689 - YCKN-MD-56102+F - GUIDE POST</option>
    <option value="A906725">A906725 - 513-434-10H - TEST INDICATORS</option>
    <option value="A946955">A946955 - F2001001-MKJ046-01 - JIG</option>
    <option value="A728828">A728828 - CDU10-15D - FREE MOUNT CYLINDER</option>
    <option value="A729205">A729205 - CDU10-5D - FREE MOUNT CYLINDER</option>
    <option value="A731539">A731539 - CDUW16-25D - FREE MOUNT CYLINDER</option>
    <option value="A731540">A731540 - CDU16-15D - FREE MOUNT CYLINDER</option>
    <option value="A780203">A780203 - CDUK6-15D-XC34 - FREE MOUNT CYLINDER</option>
    <option value="A946956">A946956 - F2001001-MKJ045-01 - JIG</option>
    <option value="A839750">A839750 - F20009-MOM000 - JIG</option>
    <option value="A346890">A346890 - COMBINATION-SPANNER-10 - COMBINATION SPANNER</option>
    <option value="A346905">A346905 - COMBINATION-SPANNER-8 - COMBINATION SPANNER</option>
    <option value="A737953">A737953 - COMBINATION-SPANNER-12 - SPANNER</option>
    <option value="A737959">A737959 - COMBINATION-SPANNER-7 - COMBINATION SPANNER</option>
    <option value="A767500">A767500 - F2000801-MCD022 - GUIDE HOLDER</option>
    <option value="A787216">A787216 - F20009-MMD18B - FELT</option>
    <option value="A025628">A025628 - XF1H-CS(3CE)-22211 - ELEMENT GUIDE PLATE</option>
    <option value="A043789">A043789 - XF2H-CS(5CFN)-22211 - ELEMENT GUIDE PLATE</option>
    <option value="A789300">A789300 - F24003-M1V217-3CE - TAPE GUIDE</option>
    <option value="A790709">A790709 - F24003-M1V204-3CE - NEEDLE HOLDER</option>
    <option value="A790710">A790710 - F24003-M1V212-3CE - NEEDLE HOLE PLATE</option>
    <option value="A823951">A823951 - F24003-M1R216-3CE - ELEMENT GUIDE</option>
    <option value="A867405">A867405 - F20009-M1V065-04-5CI - ROLL</option>
    <option value="A902028">A902028 - F24003-M1V217-02-5CI - TAPE GUIDE</option>
    <option value="A830242">A830242 - UM0640B - URETHANE TUBE</option>
    <option value="A831266">A831266 - UM0425B - URETHANE TUBE</option>
    <option value="A834919">A834919 - UM0850B - URETHANE TUBE</option>
    <option value="A838525">A838525 - UM1065B - URETHANE TUBE</option>
    <option value="A858948">A858948 - UM1280B - URETHANE TUBE</option>
  </datalist>
        <input type="number" id="quantity" placeholder="S·ªë l∆∞·ª£ng" min="1">
        <button type="button" class="btn btn-success btn-small" onclick="addItem()">‚ûï Th√™m</button>
      </div>
      <div id="itemsList"></div>
    </div>

    <div style="margin-top: 20px;">
      <label for="notes">Ghi ch√∫:</label>
      <textarea id="notes" rows="3" style="width: 100%; margin-bottom: 15px;"></textarea>
    </div>

    <div id="statusMessage" class="status-message"></div>

    <div class="form-actions" style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
      <!-- X√ìA n√∫t L∆∞u v√† Xu·∫•t file, ch·ªâ gi·ªØ l·∫°i L√†m m·ªõi v√† Copy Clipboard -->
      <button type="button" class="btn btn-secondary" onclick="clearForm()">üîÑ L√†m m·ªõi</button>
      <button type="button" class="btn btn-success" onclick="copyToClipboard()">üìã Copy Clipboard</button>
    </div>
  </form>
</div>

<!-- Th√™m modal v√†o cu·ªëi body tr∆∞·ªõc ƒë√≥ng th·∫ª -->
<div id="technicianModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
     background: rgba(0,0,0,0.5); z-index: 1000</div>;">
  <div style="position: relative; background: white; max-width: 400px; margin: 100px auto; padding: 20px; border-radius: 10px;">
    <h3 style="margin-bottom: 15px; font-size: 1.1rem;">Th√™m K·ªπ Thu·∫≠t Vi√™n M·ªõi</h3>
    <div style="margin-bottom: 12px;">
      <label for="newTechId">ID:</label>
      <input type="text" id="newTechId" class="combobox" style="width: 100%;" placeholder="Nh·∫≠p ID">
    </div>
    <div style="margin-bottom: 12px;">
      <label for="newTechName">T√™n:</label>
      <input type="text" id="newTechName" class="combobox" style="width: 100%;" placeholder="Nh·∫≠p t√™n">
    </div>
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button type="button" class="btn btn-secondary" onclick="closeTechnicianModal()">H·ªßy</button>
      <button type="button" class="btn btn-success" onclick="addNewTechnician()">Th√™m</button>
    </div>
  </div>
</div>

<!-- Th√™m modal m√°y m·ªõi v√†o cu·ªëi body, tr∆∞·ªõc ƒë√≥ng th·∫ª body -->
<div id="machineModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
     background: rgba(0,0,0,0.5); z-index: 1000;">
  <div style="position: relative; background: white; max-width: 400px; margin: 100px auto; padding: 20px; border-radius: 10px;">
    <h3 style="margin-bottom: 15px; font-size: 1.1rem;">Th√™m M√°y M·ªõi</h3>
    <div style="margin-bottom: 12px;">
      <label for="newMachineCode">M√£ m√°y:</label>
      <input type="text" id="newMachineCode" class="combobox" style="width: 100%;" 
             placeholder="V√≠ d·ª•: F2001002-MR_C054">
    </div>
    <div style="margin-bottom: 12px;">
      <label for="newMachineSerial">S·ªë s√™ri:</label>
      <input type="text" id="newMachineSerial" class="combobox" style="width: 100%;" 
             placeholder="V√≠ d·ª•: 0030">
    </div>
    <div style="margin-bottom: 12px;">
      <label for="newMachineLocation">V·ªã tr√≠:</label>
      <input type="text" id="newMachineLocation" class="combobox" style="width: 100%;" 
             placeholder="V√≠ d·ª•: J9R">
    </div>
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button type="button" class="btn btn-secondary" onclick="closeMachineModal()">H·ªßy</button>
      <button type="button" class="btn btn-success" onclick="addNewMachine()">Th√™m</button>
    </div>
  </div>
</div>

<script>
let itemsData = [], formData = [];
let masterOptions = null;
let masterMachines = null;

// Initialize Office
Office.onReady((info) => {
    if (info.host === Excel.HostType.Excel) {
        console.log('Excel Add-in initialized');
    } else {
        console.error('This is not running in Excel');
    }
});

// Function to write to Excel
async function writeToExcel() {
    try {
        if (itemsData.length === 0) {
            showMessage("Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt v·∫≠t t∆∞!", "error");
            return;
        }

        await Excel.run(async (context) => {
            console.log("Starting Excel write...");
            
            // Get the active workbook
            const sheet = context.workbook.worksheets.getItem("Maintenance Table4");
            console.log("Got sheet reference");

            // Get current used range to find last row
            const range = sheet.getUsedRange();
            await context.sync();
            const lastRow = range.rowCount;
            console.log("Last row:", lastRow);

            // Get form data
            const maintenanceDate = document.getElementById('maintenanceDate').value;
            const machineType = document.getElementById('machineType').value;
            const machineNumber = document.getElementById('machineNumber').value;
            const technician = document.getElementById('technician').value;

            console.log("Form data:", {
                maintenanceDate,
                machineType,
                machineNumber,
                technician
            });

            // Write each item to Excel
            itemsData.forEach((item, index) => {
                const rowIndex = lastRow + index;
                console.log("Writing row:", rowIndex + 1);
                const newRow = sheet.getRangeByIndexes(rowIndex, 0, 1, 8);
                newRow.values = [[
                    maintenanceDate,
                    machineType,
                    machineNumber,
                    technician,
                    item.partNumber,
                    item.description,
                    item.quantity,
                    item.remarks || ''
                ]];
            });

            await context.sync();
            console.log("Excel write completed");
            showMessage("ƒê√£ l∆∞u th√†nh c√¥ng v√†o Excel!", "success");
            clearForm(); // Clear form after successful save
        });
    } catch (error) {
        console.error("Excel error:", error);
        showMessage("L·ªói khi l∆∞u v√†o Excel: " + error.message, "error");
    }
}

// H√†m x·ª≠ l√Ω submit form
async function handleFormSubmit(event) {
    event.preventDefault();
    console.log('Form submitted');
    
    try {
        // Get form data
        const formData = {
            maintenanceDate: document.getElementById('maintenanceDate').value,
            machineType: document.getElementById('machineType').value,
            machineNumber: document.getElementById('machineNumber').value,
            technician: document.getElementById('technician').value
        };
        
        console.log('Form data:', formData);
        console.log('Items data:', itemsData);

        // Validate if we have items
        if (itemsData.length === 0) {
            showMessage("Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt v·∫≠t t∆∞!", "error");
            return false;
        }

        // Try to write to Excel
        await Excel.run(async (context) => {
            console.log('Starting Excel.run');
            
            // Get the sheet named "Maintenance Table4"
            let sheet = context.workbook.worksheets.getItem("Maintenance Table4");
            console.log('Got sheet reference');
            
            // Get the last row with data
            let range = sheet.getUsedRange();
            await context.sync();
            let lastRow = range.rowCount;
            console.log('Last row:', lastRow);
            
            // For each item in itemsData, create a new row
            itemsData.forEach((item, index) => {
                let newRow = lastRow + 1 + index;
                
                // Write form data and item data to the row
                let rowRange = sheet.getRangeByIndexes(newRow, 0, 1, 8);
                rowRange.values = [[
                    formData.maintenanceDate,
                    formData.machineType,
                    formData.machineNumber,
                    formData.technician,
                    item.partNumber,
                    item.description,
                    item.quantity,
                    item.remarks
                ]];
                console.log('Writing row:', newRow);
            });
            
            await context.sync();
            console.log('Excel write completed');
            showMessage("D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o Excel th√†nh c√¥ng!", "success");
            
            // Clear form after successful save
            clearForm();
        });
    } catch (error) {
        console.error('Error in submit handler:', error);
        showMessage("L·ªói khi l∆∞u d·ªØ li·ªáu: " + error.message, "error");
    }
    
    return false;
}

// ƒê·ªãnh nghƒ©a l·∫°i maintenanceTypeItems v·ªõi danh s√°ch c·ª• th·ªÉ
const maintenanceTypeItems = {
  '12': ['2409747', 'A764173', 'A867406', 'A867407', 'A867404', 'A841472', 'A841474', 'A841473', 'A746877', 'A880512', 'A880513'],
  '24': ['A823454', 'A032579', '1839923', 'A823456'],
  '36': ['A155855', '1839923', 'A823455', 'A168299', 'A763142', 'A754589', 'A754549', 'A754550', 'A808249', 'A823456', 'A658595', 'A799912', 'A850328', 'A799914', 'A850333', 'A786565', 'A810418', 'A782328', 'A782329', 'A633186', 'A754551', 'A819633', 'A803810', 'A824761', 'A836698', 'A820859', 'A847852', 'A820861', 'A847851', 'A824764'],
  '48': ['A787216'],
  '60': ['A029031', 'A276923', 'A793996', 'A030218', 'A786577', 'A786584', 'A786585', 'A786586', 'A035575', 'A754551', 'A168299', 'A776208', 'A776209', 'A871989', 'A830014', 'A867408', 'A867409', 'A867410', 'A836074', 'A896690', 'A877065', 'A844165', 'A138237', 'A138231', 'A816817', 'A28015', 'A840522', 'A824760', 'A807606', 'A934323', 'A934324', 'A742100', 'A168295', 'A042511', 'A676872', 'A805059', 'A820652', 'A820653', 'A820654', 'A769239', 'A754255', 'A922646', 'A825474', 'A831230', 'A823586', 'A899777', 'A821651', 'A035574', 'A805058', 'A763142', 'A754549', 'A754550', 'A903237', 'A732960', 'A732947', 'A856535', 'A732949', 'A856536'],
  '72': ['A840518', 'A840519', 'A840520', 'A926898', 'A138237', 'A776208', 'A880509', 'A880510', 'A880511', 'A742260'],
  '84': ['A776209', 'A830116'],
  '96': ['A030218'],
  '120': ['A754573', 'A362434', 'A808459', 'A754534', 'A042409', 'A803121', 'A872301', 'A031705', 'A766794', 'A018323', 'A767506', 'A766795', 'A031901', 'A786570', 'A138231', 'A138163', 'A786573', 'A786577', 'A014244', 'A881519', 'A889362', 'A821648', 'A018313', 'A889363', 'A889364', 'A766091', 'A865211', 'A029031', 'A755391', 'A773789', 'A773790', 'A633186']
};

const machineTypeSelect = document.getElementById('machineType');
machineTypeSelect.addEventListener('change', function() {
  const maintenanceType = this.value;
  const itemCodeList = document.getElementById('itemCodeList');

  // L∆∞u danh s√°ch g·ªëc l·∫ßn ƒë·∫ßu (n·∫øu ch∆∞a c√≥)
  if (!masterOptions) {
    masterOptions = Array.from(itemCodeList.querySelectorAll('option')).map(o => ({ value: o.value, text: o.textContent }));
  }

  // Reset datalist
  itemCodeList.innerHTML = '';

  // N·∫øu l√† b·∫£o d∆∞·ª°ng ƒë·ªôt xu·∫•t (ad-hoc)
  if (maintenanceType === 'ad-hoc') {
    masterOptions.forEach(opt => {
      const newOption = document.createElement('option');
      newOption.value = opt.value;
      newOption.textContent = opt.text;
      itemCodeList.appendChild(newOption);
    });
    showMessage(`ƒê√£ hi·ªÉn th·ªã t·∫•t c·∫£ ${masterOptions.length} v·∫≠t t∆∞ cho b·∫£o d∆∞·ª°ng ƒë·ªôt xu·∫•t`, 'success');
    return;
  }

  // X·ª≠ l√Ω cho c√°c lo·∫°i b·∫£o d∆∞·ª°ng ƒë·ªãnh k·ª≥
  if (maintenanceTypeItems[maintenanceType]) {
    const allowedCodes = maintenanceTypeItems[maintenanceType];
    let count = 0;
    masterOptions.forEach(opt => {
      const code = opt.value.split(' ')[0];
      if (allowedCodes.includes(code)) {
        const newOption = document.createElement('option');
        newOption.value = opt.value;
        newOption.textContent = opt.text;
        itemCodeList.appendChild(newOption);
        count++;
      }
    });
    showMessage(`ƒê√£ l·ªçc ${count} v·∫≠t t∆∞ cho b·∫£o d∆∞·ª°ng ${maintenanceType} th√°ng`, 'success');
  } else {
    showMessage(`Kh√¥ng t√¨m th·∫•y danh s√°ch v·∫≠t t∆∞ cho lo·∫°i b·∫£o d∆∞·ª°ng ${maintenanceType}`, 'error');
  }
});

function addItem() {
  const inputVal = document.getElementById('itemCode').value.trim();
  const qty = document.getElementById('quantity').value;
  const maintenanceType = document.getElementById('machineType').value;

  if (!inputVal || !qty) {
    showMessage('Vui l√≤ng nh·∫≠p ƒë·ªß m√£ v√† s·ªë l∆∞·ª£ng v·∫≠t t∆∞', 'error');
    return;
  }

  // L·∫•y m√£ ch√≠nh (tr∆∞·ªùng h·ª£p ng∆∞·ªùi d√πng paste ƒë·∫ßy ƒë·ªß "CODE - desc")
  const itemCode = inputVal.split(' ')[0];

  // N·∫øu kh√¥ng ph·∫£i ad-hoc th√¨ ki·ªÉm tra v·∫≠t t∆∞ thu·ªôc lo·∫°i
  if (maintenanceType !== 'ad-hoc' && maintenanceTypeItems[maintenanceType] && !maintenanceTypeItems[maintenanceType].includes(itemCode)) {
    showMessage('V·∫≠t t∆∞ kh√¥ng thu·ªôc lo·∫°i b·∫£o d∆∞·ª°ng n√†y', 'error');
    return;
  }

  // Ki·ªÉm tra s·ªë l∆∞·ª£ng t·ªëi ƒëa (n·∫øu c√≥)
  const maxItems = maintenanceType === 'ad-hoc' ? Infinity : (maintenanceTypeItems[maintenanceType]?.length || Infinity);
  if (itemsData.length >= maxItems) {
    showMessage(`ƒê√£ ƒë·∫°t s·ªë l∆∞·ª£ng t·ªëi ƒëa ${maxItems} v·∫≠t t∆∞ cho lo·∫°i b·∫£o d∆∞·ª°ng n√†y`, 'error');
    return;
  }

  // Find item description t·ª´ masterOptions ho·∫∑c datalist hi·ªán t·∫°i
  let found = null;
  if (masterOptions) {
    found = masterOptions.find(o => o.value === itemCode);
  }
  if (!found) {
    const opt = document.querySelector(`#itemCodeList option[value="${itemCode}"]`);
    if (opt) found = { value: opt.value, text: opt.textContent || opt.text };
  }

  itemsData.push({
    code: itemCode,
    desc: found ? found.text.split(' - ').slice(1).join(' - ') : '',
    quantity: parseInt(qty)
  });

  renderItemsList();
  document.getElementById('itemCode').value = '';
  document.getElementById('quantity').value = '';
  showMessage('ƒê√£ th√™m v·∫≠t t∆∞ th√†nh c√¥ng', 'success');
}

function renderItemsList() {
  const list = document.getElementById('itemsList');
  list.innerHTML = itemsData.map((item, index) => `
    <div class="list-item">
      <div class="item-content">
        <span class="item-code">${item.code}</span>
        <span>${item.desc}</span>
        <span class="item-quantity">x${item.quantity}</span>
      </div>
      <button type="button" class="btn btn-danger btn-small" onclick="removeItem(${index})">üóëÔ∏è</button>
    </div>
  `).join('');
}

// Th√™m g·ªçi h√†m kh·ªüi t·∫°o khi load trang
document.addEventListener('DOMContentLoaded', () => {
  // L∆∞u danh s√°ch g·ªëc datalist item code
  const itemCodeList = document.getElementById('itemCodeList');
  masterOptions = Array.from(itemCodeList.querySelectorAll('option')).map(o => ({ value: o.value, text: o.textContent }));

  // L∆∞u danh s√°ch g·ªëc m√°y t·ª´ datalist
  const machineList = document.getElementById('machineList');
  masterMachines = Array.from(machineList.querySelectorAll('option')).map(o => ({ value: o.value, text: o.textContent }));
  
  document.getElementById('maintenanceDate').value = new Date().toISOString().split('T')[0];
  renderItemsList();
});

// Th√™m h√†m hi·ªÉn th·ªã th√¥ng b√°o
function showMessage(message, type) {
  const statusMessage = document.getElementById('statusMessage');
  statusMessage.textContent = message;
  statusMessage.className = `status-message ${type === 'error' ? 'status-error' : 'status-success'}`;
  statusMessage.style.display = 'block';
  setTimeout(() => {
    statusMessage.style.display = 'none';
  }, 3000);
}

// S·ª¨A l·∫°i ch·ª©c nƒÉng n√∫t L√†m m·ªõi: X√≥a to√†n b·ªô form v√† danh s√°ch v·∫≠t t∆∞
function clearForm() {
  document.getElementById('excelForm').reset();
  itemsData = [];
  renderItemsList();
  // ƒê·∫∑t l·∫°i ng√†y b·∫£o d∆∞·ª°ng v·ªÅ h√¥m nay
  document.getElementById('maintenanceDate').value = new Date().toISOString().split('T')[0];
  showMessage('ƒê√£ l√†m m·ªõi form', 'success');
}

// S·ª¨A l·∫°i ch·ª©c nƒÉng Copy Clipboard: Copy th√¥ng tin form + danh s√°ch v·∫≠t t∆∞ d·∫°ng b·∫£ng text
function copyToClipboard() {
  const machineInput = document.getElementById('machine').value.trim();
  const machineType = document.getElementById('machineType').options[document.getElementById('machineType').selectedIndex].text;
  const maintenanceDate = document.getElementById('maintenanceDate').value;
  const shift = document.getElementById('shift').options[document.getElementById('shift').selectedIndex].text;
  const technician = document.getElementById('technician').value;
  const notes = document.getElementById('notes').value;

  // L·∫•y m√¥ t·∫£ ƒë·∫ßy ƒë·ªß m√°y t·ª´ masterMachines n·∫øu kh·ªõp m√£
  let fullMachineText = machineInput;
  if (masterMachines) {
    const m = masterMachines.find(x => x.value === machineInput || x.text === machineInput);
    if (m) fullMachineText = m.text;
  }

  let text = '';
  
  if(itemsData.length > 0) {
    itemsData.forEach(item => {
      // Th√™m ca l√†m vi·ªác v√†o d·ªØ li·ªáu xu·∫•t
      text += `${maintenanceDate}\t${shift}\t${fullMachineText}\t${item.code}\t${item.desc}\t${item.quantity}\t${machineType}\t${technician}\t${notes}\n`;
    });

    navigator.clipboard.writeText(text).then(() => {
      showMessage('ƒê√£ copy d·ªØ li·ªáu v√†o clipboard', 'success');
    }, () => {
      showMessage('Kh√¥ng th·ªÉ copy v√†o clipboard', 'error');
    });
  } else {
    showMessage('Ch∆∞a c√≥ v·∫≠t t∆∞ n√†o ƒë·ªÉ copy', 'error');
  }
}

// Th√™m v√†o ph·∫ßn script
function openTechnicianModal() {
  document.getElementById('technicianModal').style.display = 'block';
}

function closeTechnicianModal() {
  document.getElementById('technicianModal').style.display = 'none';
  document.getElementById('newTechId').value = '';
  document.getElementById('newTechName').value = '';
}

function addNewTechnician() {
  const id = document.getElementById('newTechId').value.trim();
  const name = document.getElementById('newTechName').value.trim();
  
  if (!id || !name) {
    showMessage('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß ID v√† t√™n', 'error');
    return;
  }

  const technicianSelect = document.getElementById('technician');
  const newOption = document.createElement('option');
  newOption.value = id;
  newOption.text = `${name} - ID:${id}`;
  technicianSelect.appendChild(newOption);

  // L∆∞u v√†o localStorage ƒë·ªÉ duy tr√¨ sau khi refresh
  const technicians = JSON.parse(localStorage.getItem('technicians') || '[]');
  technicians.push({ id, name });
  localStorage.setItem('technicians', JSON.stringify(technicians));

  showMessage('ƒê√£ th√™m k·ªπ thu·∫≠t vi√™n m·ªõi', 'success');
  closeTechnicianModal();
}

// Th√™m h√†m load technicians khi kh·ªüi ƒë·ªông
document.addEventListener('DOMContentLoaded', function() {
  // Load saved technicians
  const technicians = JSON.parse(localStorage.getItem('technicians') || '[]');
  const technicianSelect = document.getElementById('technician');
  technicians.forEach(tech => {
    const option = document.createElement('option');
    option.value = tech.id;
    option.text = `${tech.name} - ID:${tech.id}`;
    technicianSelect.appendChild(option);
  });
});

// Th√™m c√°c h√†m x·ª≠ l√Ω v√†o ph·∫ßn script
function openMachineModal() {
  document.getElementById('machineModal').style.display = 'block';
}

function closeMachineModal() {
  document.getElementById('machineModal').style.display = 'none';
  document.getElementById('newMachineCode').value = '';
  document.getElementById('newMachineSerial').value = '';
  document.getElementById('newMachineLocation').value = '';
}

function addNewMachine() {
  const code = document.getElementById('newMachineCode').value.trim();
  const serial = document.getElementById('newMachineSerial').value.trim();
  const location = document.getElementById('newMachineLocation').value.trim();
  
  if (!code || !serial || !location) {
    showMessage('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin m√°y', 'error');
    return;
  }

  const machineList = document.getElementById('machineList');
  const newOption = document.createElement('option');
  const machineText = `${code} - ${serial} - ${location}`;
  newOption.value = code;
  newOption.text = machineText;
  machineList.appendChild(newOption);

  // L∆∞u v√†o localStorage
  const machines = JSON.parse(localStorage.getItem('machines') || '[]');
  machines.push({ code, serial, location });
  localStorage.setItem('machines', JSON.stringify(machines));

  // C·∫≠p nh·∫≠t masterMachines
  if (masterMachines) {
    masterMachines.push({ value: code, text: machineText });
  }

  showMessage('ƒê√£ th√™m m√°y m·ªõi th√†nh c√¥ng', 'success');
  closeMachineModal();
}

// S·ª≠a l·∫°i ph·∫ßn document.addEventListener('DOMContentLoaded'...)
document.addEventListener('DOMContentLoaded', function() {
  // ...existing code...

  // Load saved machines
  const machines = JSON.parse(localStorage.getItem('machines') || '[]');
  const machineList = document.getElementById('machineList');
  machines.forEach(machine => {
    const option = document.createElement('option');
    option.value = machine.code;
    option.text = `${machine.code} - ${machine.serial} - ${machine.location}`;
    machineList.appendChild(option);
  });

  // Update masterMachines
  masterMachines = Array.from(machineList.querySelectorAll('option')).map(o => ({ 
    value: o.value, 
    text: o.textContent 
  }));
});

function removeItem(index) {
  if (index >= 0 && index < itemsData.length) {
    const removedItem = itemsData[index];
    itemsData.splice(index, 1);
    renderItemsList();
    showMessage(`ƒê√£ x√≥a v·∫≠t t∆∞ ${removedItem.code}`, 'success');
  }
}

// Initialize Office.js
Office.onReady((info) => {
    if (info.host === Excel.HostType.Excel) {
        document.getElementById('excelForm').onsubmit = async (event) => {
            event.preventDefault();
            
            const formData = {
                maintenanceDate: document.getElementById('maintenanceDate').value,
                machineType: document.getElementById('machineType').value,
                machineNumber: document.getElementById('machineNumber').value,
                technician: document.getElementById('technician').value
            };
            
            if (itemsData.length === 0) {
                showMessage("Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt v·∫≠t t∆∞!", "error");
                return;
            }
            
            await writeToExcel(formData, itemsData);
        };
    }
});
</script>
</body>
</html>
